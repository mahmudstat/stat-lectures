<style>
#drawingCanvas {
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  z-index: 1000;
  pointer-events: none; /* default to off */
}

#controlsWrapper {
  position: fixed;
  top: 10px;
  left: 10px;
  z-index: 1001;
}

#controls {
  display: none;
  flex-direction: column;
  align-items: center;
  background: #b3b3ff;
  padding: 5px;
  border-radius: 10px;
  gap: 5px;
}

#controls input[type="color"],
#controls input[type="range"],
#controls button {
  width: 40px;
  height: 40px;
}

#toggleControls {
  width: 40px;
  height: 40px;
  font-size: 20px;
  background: none;
  border: none;
}

#eraserCursor {
  position: fixed;
  border: 1px solid red;
  border-radius: 50%;
  pointer-events: none;
  z-index: 1002;
  display: none;
}
</style>

<div id="controlsWrapper">
  <button id="toggleControls">🎨</button>
  <div id="controls">
    <button id="penTool" title="Pen">🖉</button>
    <input type="color" id="penColor" value="#339966" />
    <input type="range" id="penSize" min="1" max="20" value="5" />

    <button id="eraserTool" title="Eraser">🩹</button>
    <input type="range" id="eraserSize" min="10" max="100" value="20" />

    <button id="undo" title="Undo">↩️</button>
    <button id="clear" title="Clear">🗑️</button>
  </div>
</div>

<div id="eraserCursor"></div>
<canvas id="drawingCanvas"></canvas>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const canvas = document.getElementById('drawingCanvas');
  const ctx = canvas.getContext('2d');
  const eraserCursor = document.getElementById('eraserCursor');

  let drawing = false;
  let erasing = false;
  let lastX = 0;
  let lastY = 0;
  let history = [];

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  function getPosition(e) {
    if (e.touches && e.touches[0]) e = e.touches[0];
    return { x: e.clientX, y: e.clientY };
  }

  function updateEraserCursor(x, y) {
    const size = document.getElementById('eraserSize').value;
    eraserCursor.style.width = `${size}px`;
    eraserCursor.style.height = `${size}px`;
    eraserCursor.style.left = `${x - size / 2}px`;
    eraserCursor.style.top = `${y - size / 2}px`;
  }

  function startDrawing(e) {
    drawing = true;
    const { x, y } = getPosition(e);
    lastX = x;
    lastY = y;
    canvas.style.pointerEvents = 'auto';
  }
  function stopDrawing() {
    if (drawing) {
      history.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
    }
    drawing = false;
  }
  function draw(e) {
    if (!drawing) return;
    const { x, y } = getPosition(e);
    const size = erasing ? document.getElementById('eraserSize').value : document.getElementById('penSize').value;
    ctx.lineWidth = size;
    ctx.lineCap = 'round';
    ctx.strokeStyle = erasing ? '#ffffff' : document.getElementById('penColor').value;

    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();
    lastX = x;
    lastY = y;
  }

  canvas.addEventListener('mousedown', startDrawing);
  canvas.addEventListener('mousemove', function(e) {
    if (erasing) {
      const { x, y } = getPosition(e);
      updateEraserCursor(x, y);
    }
    draw(e);
  });
  canvas.addEventListener('mouseup', stopDrawing);

  canvas.addEventListener('touchstart', startDrawing);
  canvas.addEventListener('touchmove', function(e) {
    if (erasing) {
      const { x, y } = getPosition(e);
      updateEraserCursor(x, y);
    }
    draw(e);
  });
  canvas.addEventListener('touchend', stopDrawing);

  const penTool = document.getElementById('penTool');
  const eraserTool = document.getElementById('eraserTool');
  const undoBtn = document.getElementById('undo');
  const clearBtn = document.getElementById('clear');
  const toggleControls = document.getElementById('toggleControls');
  const controls = document.getElementById('controls');
  const eraserSizeInput = document.getElementById('eraserSize');

  penTool.addEventListener('click', () => {
    erasing = false;
    eraserCursor.style.display = 'none';
  });

  eraserTool.addEventListener('click', () => {
    erasing = true;
    eraserCursor.style.display = 'block';
  });

  undoBtn.addEventListener('click', () => {
    if (history.length > 0) {
      const prev = history.pop();
      ctx.putImageData(prev, 0, 0);
    }
  });

  clearBtn.addEventListener('click', () => {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  });

  toggleControls.addEventListener('click', () => {
    const visible = controls.style.display === 'flex';
    controls.style.display = visible ? 'none' : 'flex';
    canvas.style.pointerEvents = visible ? 'none' : 'auto';
    if (!visible && erasing) eraserCursor.style.display = 'block';
    if (visible) eraserCursor.style.display = 'none';
  });
});
</script>
